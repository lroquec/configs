---
- hosts: localhost
  become: true
  tasks:
    - name: "Add chrome apt key"
      ansible.builtin.get_url:
        url: https://dl-ssl.google.com/linux/linux_signing_key.pub
        dest: /etc/apt/keyrings/chrome.asc

    - name: Add specified repository into sources list using specified filename
      ansible.builtin.apt_repository:
        repo: 'deb [arch=amd64 signed-by=/etc/apt/keyrings/chrome.asc] http://dl.google.com/linux/chrome/deb/ stable main'
        state: present
        filename: google-chrome

    - name: "Add vscode apt key"
      ansible.builtin.apt_key:
        url: https://packages.microsoft.com/keys/microsoft.asc
        state: present

    - name: "Add vivaldi apt key"
      ansible.builtin.get_url:
        url: https://repo.vivaldi.com/archive/linux_signing_key.pub
        dest: /etc/apt/keyrings/vivaldi.asc

    - name: "Add vscode repo"
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main"
        state: present

    - name: "Add vivaldi repo"
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/vivaldi.asc] https://repo.vivaldi.com/archive/deb/ stable main"
        state: present

    - name: "Add copyq repo"
      ansible.builtin.apt_repository:
        repo: 'ppa:hluk/copyq'
        state: present

    - name: "Add vagrant repo key"
      ansible.builtin.get_url:
        url: https://apt.releases.hashicorp.com/gpg
        dest: /etc/apt/keyrings/vagrant.asc

    - name: "Add vagrant repo"
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/vagrant.asc] https://apt.releases.hashicorp.com impish main"
        state: present

    - name: "Update repos first"
      ansible.builtin.apt: update_cache=yes force_apt_get=yes cache_valid_time=3600

    - name: "Update system"
      ansible.builtin.apt: upgrade=dist force_apt_get=yes

    - name: "Check if reboot is needed"
      register: reboot_required_file
      stat: path=/var/run/reboot-required get_md5=no

    - name: "Reboot system"
      ansible.builtin.reboot:
        msg: "Reboot initiated by Ansible due to kernel updates"
        connect_timeout: 5
        reboot_timeout: 300
        pre_reboot_delay: 0
        post_reboot_delay: 30
        test_command: uptime
      when: reboot_required_file.stat.exists

    - name: "Now install my default packages"
      ansible.builtin.apt:
        name: "{{ item }}"
        update_cache: yes
      loop:
        - vim
        - curl
        - unzip
        - wget
        - git
        - tldr
        - flatpak
        - build-essential
        - software-properties-common
        - apt-transport-https
        - code
        - net-tools
        - tcpdump
        - zsh
        - fonts-powerline
        - copyq
        - google-chrome-stable
        - gnupg2
        - vivaldi-stable
        - ubuntu-restricted-extras
        - vlc
        - python3-pip
        - libavcodec-extra
        - bash-completion
        - gimp
        - virtualbox
        - vagrant
        - jq
        - libreoffice
        - htop
        - thunderbird
        - preload
        - tlp
        - tlp-rdw
        - bleachbit
        - kitty

    - name: Check Docker Installed
      shell: which docker
      register: docker_check
      ignore_errors: yes

      # will install the latest version of docker
    - name: Install Docker
      shell: curl https://get.docker.com/ | sh
      when: docker_check.rc == 1

    - name: Setup Docker
      shell: |
        usermod -aG docker "{{ host_username }}"
        systemctl enable docker
        systemctl start docker
      when: docker_check.rc == 1

    - name: Install docker compose
      pip:
        name: docker-compose
        state: present
        executable: pip3

    - name: Install vimplug for vim plugins
      shell: curl -fLo ~/.vim/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
      become: no
      ignore_errors: yes

    - name: Install vim plugins
      shell: vim +PlugInstall +qall
      become: no
      ignore_errors: yes

    - name: Disable chsh authentication
      lineinfile:
        dest: /etc/pam.d/chsh
        regexp: '.*pam_shells\.so'
        line: 'auth sufficient  pam_shells.so'

    - name: Install oh-my-zsh
      shell: sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
      become: no

    - name: Set zsh as default shell
      shell: chsh -s $(which zsh)
      become: no

    - name: Re-enable chsh authentication
      lineinfile:
        dest: /etc/pam.d/chsh
        regexp: '.*pam_shells\.so'
        line: 'auth required  pam_shells.so'

    - name: Clone dotfiles
      git:
        repo: https://github.com/lroquec/configs.git
        dest: "{{ home_directory }}"
        version: master
        become: no

    - name: Creating a symlink for vim
      ansible.builtin.file:
        src: '{{ home_directory }}/configs/vimrc'
        dest: '{{ home_directory }}/.vimrc'
        state: link

    - name: Creating a symlink for vim
      ansible.builtin.file:
        src: '{{ home_directory }}/configs/vim'
        dest: '{{ home_directory }}/.vim'
        state: link

    - name: Creating a symlink for vim
      ansible.builtin.file:
        src: '{{ home_directory }}/configs/oh-my-zsh'
        dest: '{{ home_directory }}/.oh-my-zsh'
        state: link

    - name: Creating a symlink for vim
      ansible.builtin.file:
        src: '{{ home_directory }}/configs/.zprofile'
        dest: '{{ home_directory }}/.zprofile'
        state: link

    - name: Creating a symlink for vim
      ansible.builtin.file:
        src: '{{ home_directory }}/configs/.zshrc'
        dest: '{{ home_directory }}/.zshrc'
        state: link
